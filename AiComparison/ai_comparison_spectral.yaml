extends: [[spectral:oas, 'off']]

documentationUrl: https://github.com/Grinseteddy/AiCollections/blob/main/AiComparison/DescriptionLinter.md

functions:
  - assert-http-codes-for-operation
  - count-resource-types
  - is-object-schema
  - is-error-json-schema
  - rule-132
  - is-uuid-id
  - is-not-undefined
  - enum-allow-list
  - filename-ends-with-audience
  - filename-begins-with-bc-name
  - scope-conventions
  - has-no-scopes
  - has-exactly-one-of-required-headers
  - title-begins-with-bc-name
  - title-ends-with-audience
  - has-audience-header
  - has-path-prefix # rule 02-07

rules:
  # https://meta.stoplight.io/docs/spectral/docs/reference/openapi-rules.md#oas3-schema
  oas3-schema: true

 # helps identifying parser problem in yaml
  MUST-null:
    message: "problem parsing {{property}}"
    description: YAML Parser Problem
    documentationUrl: https://github.com/Grinseteddy/AiCollections/blob/main/AiComparison/DescriptionLinter.md
    severity: error # Not an error as you only should provide an example to help your consumers
    given: $.paths..[?(@ == null )]
    then:
      field: examples
      function: truthy

  # MUSS eine OpenApi-Spezifikation pro Zielgruppe (audience) verwalten [01-05]
  01-05_filename-MUST-begin-with-bc-name:
    message: "{{error}}"
    description: MUSS eine OpenApi-Spezifikation pro Zielgruppe (audience) verwalten [01-05]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API/
    severity: error
    given: $
    then:
      function: filename-begins-with-bc-name

  # MUSS eine OpenApi-Spezifikation pro Zielgruppe (audience) verwalten [01-05]
  01-05_filename-MUST-end-with-audience:
    message: "{{error}}"
    description: MUSS eine OpenApi-Spezifikation pro Zielgruppe (audience) verwalten [01-05]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API/
    severity: error
    given: $
    then:
      function: filename-ends-with-audience
      functionOptions:
        audienceToSuffixMap:
          "public-external" : "-api"
          "federation-internal" : "-federation-internal-api"
          "insurance-internal" : "-insurance-internal-api"
          "cluster-internal" : "-cluster-internal-api"
          "service-internal" : "-service-internal-api"

  # MUST follow API title convention [01-10]
  01-10_title-MUST-begin-with-bc-name:
    message: "{{error}}"
    description: MUSS API Titel Konvention folgen [01-10]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      - field: title
        function: truthy
      - field: title
        function: title-begins-with-bc-name
        functionOptions:
          validBcNames:
            - Claim Request
            - Claim Verification
            - Incoming Invoices
            - Claim Invoice Confirmation
            - Copayment Insurant
            - Indemnification
            - Fee Codes
            - Bonus Program Configuration
            - Electronic Patient Receipts
            - Electronic Patient Record
            - Individual Benefits
            - Insurance Period
            - Health Insurance Card
            - Premium Ledger Insurant
            - Private Customer Data Management
            - Corporate Customer Data Management
            - Insurance Period Employer
            - Premium Ledger Corporate Customer
            - Other Parties Management
            - Service Provider Data Management
            - Service Provider Contracts
            - Private Customer Care
            - Corporate Customer Care
            - Appointment Management
            - Campaign Management
            - Manage Events
            - Clear Event
            - Workflow Control
            - Intent Routing
            - Responsibility Assignment
            - Skill Management
            - Workload
            - Contact Management
            - In And Outbox
            - Document Upload
            - Input Management
            - Output Management
            - Virus Scanning
            - Document Signature
            - Document Archiving
            - Employee Data Display
            - Collection And Disbursement Corporate Customer
            - Collection and Disbursement Private Customer
            - Process Tracking
            - Official Statistics
            - Security Token Service
            - Employee Authentication
            - Corporate Customer Authorization
            - Private Customer Authorization
            - Service Provider Authorization
            - Consent Management
            - Ident Verification
            - Audit Read And Change Logging
            - Notification Service

# MUST follow API title convention [01-10]
  01-10_title-MUST-end-with-audience:
    message: "{{error}}"
    description: MUSS API Titel Konvention folgen [01-10]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      field: title
      function: title-ends-with-audience
      functionOptions:
        audienceToTitleSuffixMap:
          "public-external" : ""
          "federation-internal" : " - federation-internal"
          "insurance-internal" : " - insurance-internal"
          "cluster-internal" : " - cluster-internal"
          "service-internal" : " - service-internal"

  # MUST contain API meta information [02-01]
  02-01_MUST-have-info-description:
    message: Missing `info.description`.
    description: MUSS OpenAPI Spezifikationen muss Meta-Informationen enthalten [02-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      field: description
      function: truthy

  # MUST contain API meta information [02-01]
  02-01_MUST-have-info-contact-name:
    message: Missing `info.contact.name`.
    description: MUSS OpenAPI Spezifikationen muss Meta-Informationen enthalten [02-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      field: contact.name
      function: truthy

  # MUST contain API meta information [02-01]
  02-01_MUST-have-info-contact-url:
    message: Missing `info.contact.url`.
    description: MUSS OpenAPI Spezifikationen muss Meta-Informationen enthalten [02-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      field: contact.url
      function: truthy

  # MUST contain API meta information [02-01]
  02-01_MUST-have-info-contact-email:
    message: Missing `info.contact.email`.
    description: MUSS OpenAPI Spezifikationen muss Meta-Informationen enthalten [02-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      field: contact.email
      function: truthy

  # MUST contain API meta information [02-01]
  02-01_MUST-have-info-x-api-id:
    message: Missing `info.x-api-id`.
    description: MUSS OpenAPI Spezifikationen muss Meta-Informationen enthalten [02-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      field: x-api-id
      function: truthy

  # MUST use semantic versioning [02-02]
  # => https://opensource.zalando.com/restful-api-guidelines/#116
  02-02_MUST-use-semantic-versioning:
    message: '{{error}}'
    description: MUSS Semantic Versioning verwenden [02-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info.version
    then:
      function: schema
      functionOptions:
        schema:
          type: string
          pattern: '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*)?$'

  # MUST provide API identifiers [02-03]
  02-03_MUST-provide-api-identifiers:
    message: '{{error}}'
    description: MUSS einen eindeutigen API Identifier verwenden [02-03]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info.x-api-id
    then:
      function: schema
      functionOptions:
        schema:
          type: string
          pattern: ^[a-z0-9][a-z0-9-:.]{6,62}[a-z0-9]$

  # MUST provide API audience [02-04]
  02-04_MUST-provide-api-audience:
    message: "{{error}}"
    description: MUSS Zielgruppe definieren [02-04]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.info
    then:
      - field: x-audience
        function: enumeration
        functionOptions:
          values:
            - public-external
            - federation-internal
            - insurance-internal
            - cluster-internal
            - service-internal

  # MUSS den Bounded-Context als Präfix für jeden Path verwenden (02-07)
  02-07_MUST-use-bc-name-as-path-prefix:
    message: "{{error}}"
    description: MUSS den Bounded-Context als Präfix für jeden Path verwenden (02-07)
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*
    then:
      function: has-path-prefix

  # MUSS follow naming conventions for permission scopes [03-02]
  03-02_MUST-define-security:
    message: "{{error}}"
    description: MUSS security am Endpunkt definieren [03-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*
    then:
      - field: security
        function: schema
        functionOptions:
          schema:
            type: array
            minItems: 1

  # MUSS follow naming conventions for permission scopes [03-02]
  03-ß2_MUST-define-security-requirement-object:
    message: "{{error}}"
    description: MUSS 'openIdConnect' als security requirement object am Endpunkt definieren [03-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*.security[*]
    then:
      field: openIdConnect
      function: truthy

  # MUSS follow naming conventions for permission scopes [03-02]
  03-02_MUST-follow-scope-conventions:
    message: "{{error}}"
    description: MUSS die Namenskonvention für Berechtigungen (Scopes) folgen [03-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*.security[*].openIdConnect
    then:
      function: scope-conventions
      functionOptions:
        audienceToPerimeterPermissionMap:
          "federation-internal" : "federation_internal"
          "insurance-internal" : "insurance_internal"
          "cluster-internal" : "insurance_internal"
          "service-internal" : "insurance_internal"
        httpVerbToAccessModesMap:
          "GET" : ["read"]
          "POST" : ["write", "read"]
          "PUT" : ["write"]
          "PATCH" : ["write"]
          "DELETE" : ["write"]

  # MUSS follow naming conventions for permission scopes [03-02]
  03-02_MAY-have-no-scope:
    message: "{{error}}"
    description: DARF Berechtigung (scope) weglassen für öffentliche Endpunkte, die keine Autorisierung erfordern. [03-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths.*.*.security[*].openIdConnect
    then:
      function: has-no-scopes
      functionOptions:
        audiences:
          - "public-external"

  # MUST define a format for number and integer types [04-02]
  04-02_MUST-define-a-format-for-number-types:
    message: Numeric properties MUST have valid format specified
    description: MUSS das Format von number und integer Typen definieren [04-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*..schema..properties..[?(@ && @.type=='number')]
    then:
      - field: format
        function: defined
      - field: format
        function: pattern
        functionOptions:
          match: ^(float|double|decimal)$

  # MUST define a format for number and integer types [04-02]
  04-02_MUST-define-a-format-for-integer-types:
    message: Numeric properties MUST have valid format specified
    description: MUSS das Format von number und integer Typen definieren [04-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*..schema..properties..[?(@ && @.type=='integer')]
    then:
      - field: format
        function: defined
      - field: format
        function: pattern
        functionOptions:
          match: ^(int32|int64|bigint)$

  # MUST use standard formats for date and time properties [04-04]
  04-04_MUST-use-standard-formats-for-date-and-time-properties-example:
    message: "You SHOULD provide an example for {{property}}"
    description: MUSS Standardformate für Datum & Zeit verwenden [04-04]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn # Not an error as you only SHOULD provide an example to help your consumers
    given: $.paths..[?((@ != null && @.type === 'string') && (@.format === 'date-time' || @.format === 'date' || @.format === 'time' || @.format === 'duration' || @.format === 'period'))]
    then:
      field: examples
      function: truthy

  # MUST use standard formats for date and time properties [04-04]
  04-04_MUST-use-standard-formats-for-date-and-time-properties-utc:
    message: "You SHOULD UTC for {{property}}"
    description: MUSS Standardformate für Datum & Zeit verwenden [04-04]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn # Not an error as you only SHOULD provide an example to help your consumers
    given: $.paths..[?( @!= null && @.type === 'string' && @.format === 'date-time')]
    then:
      field: examples
      function: pattern
      functionOptions:
        match: "Z$"

  # MUSS UUIDs als Identifier verwenden [04-06]
  04-06_MUST-use-uuid-for-ids:
    message: "You MUST use UUIDs for Identifiers for {{property}} if possible"
    description: MUSS UUIDs als Identifier verwenden [04-06]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths..[?(@ != null && @.schema != null)]
    then:
      function: is-uuid-id

  # SHOULD NOT use /api as base path [05-01]
  05-01_SHOULD-NOT-use-api-as-base-path:
    message: Path SHOULD NOT start with /api
    description: SOLLTE Kein /api als Pfadanfang in API-Services verwenden [05-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths.*~
    then:
      function: pattern
      functionOptions:
        notMatch: ^/api

  # MUST use lowercase separate words with hyphens for path segments [05-04]
  05-04_MUST-use-lowercase-with-hypens-for-path-segements:
    message: Path segments have to be lowercase separate words with hyphens
    description: MUSS kebab-case für den Pfad verwenden [05-04]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*~
    then:
      function: pattern
      functionOptions:
        match: ^(?=((([\/a-z][a-z0-9\-\/]*)?({[^}]*})?)+))\1$

  # MUST use normalized paths without empty path segments and trailing slashes [05-05]
  05-04_MUST-use-normalized-paths-without-empty-path-segments:
    message: Empty path segments are not allowed
    description: MUSS normalisierte Pfade verwenden [05-05]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*~
    then:
      function: pattern
      functionOptions:
        notMatch: //

  # MUST use normalized paths without empty path segments and trailing slashes [05-05]
  05-05_MUST-use-normalized-paths-without-trailing-slash:
    message: Path with trailing slash is not allowed
    description: MUSS normalisierte Pfade verwenden [05-05]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*~
    then:
      function: pattern
      functionOptions:
        notMatch: /$

  # SHOULD limit number of resource types [05-09]
  05-09_SHOULD-limit-number-of-resource-types:
    message: '{{error}}'
    description: SOLLTE Anzahl von Ressourcen pro API limitieren [05-09]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths
    then:
      function: count-resource-types
      functionOptions:
        max: 8

  # SHOULD limit number of sub-resource levels [05-10]
  05-10_SHOULD-limit-number-of-sub-resource-levels:
    message: Sub-resource levels SHOULD by <= 3
    description: SOLLTE Schachtelungstiefe von Sub-Ressourcen limitieren [05-10]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths.*~
    then:
      function: pattern
      functionOptions:
        match: ^\/[^\/]*((\/{[^}]*})*\/[^\/]*(\/{[^}]*})*){0,3}\/?$

  # MUST use camelCase for query parameters [05-11]
  05-11_MUST-use-snake-case-for-query-parameters:
    message: Query parameters MUST be camelCase
    description: MUSS camelCase für Query-Parameter verwenden [05-11]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*.parameters[?(@ && @.in=='query')].name
    then:
      function: pattern
      functionOptions:
        match: '^[a-z][a-z]*(([A-Z][a-z]+)*[A-Z]?|([a-z]+[A-Z])*|[A-Z])$'

  # MUST property names MUST be ASCII camelCase [06-04]
  06-04_MUST-use-camel-case-for-property-names:
    message: Property name has to be ASCII camelCase
    description: MUSS Attribut-Namen im camelCase [06-04]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*[responses,requestBody]..content..schema..properties.*~
    then:
      function: pattern
      functionOptions:
        match: '^[a-z][a-z]*(([A-Z][a-z]+)*[A-Z]?|([a-z]+[A-Z])*|[A-Z])$'

  # SHOULD declare enum values using UPPER_SNAKE_CASE format [06-05]
  06-05_SHOULD-declare-enum-values-using-upper-snake-case-format:
    message: 'Enum values SHOULD be in UPPER_SNAKE_CASE format'
    description: SOLLTE Enum-Werte in SNAKE_CASE [06-05]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths..[?(@ && @.type=='string')].[enum,x-extensible-enum].*
    then:
      function: pattern
      functionOptions:
        match: ^[A-Z_0-9.]*$

  # MUSS boolean Typen dürfen kein null verwenden [06-09]
  06-09_MUST-NOT-use-null-for-boolean:
    message: "MUST NOT use null for boolean properties - provide a default"
    description: MUSS boolean Typen dürfen kein null verwenden [06-09]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths..[?((@ != null && @.type === 'boolean'))]
    then:
      field: default
      function: is-not-undefined

  # SOLL leere Arrays nicht als null verwenden [06-10]
  06-10_SHOULD-NOT-use-null-for-empty-arrays:
    message: "provide the field minItems for arrays. Consider providing [] for nullable lists"
    description: SOLL leere Arrays nicht als null verwenden [06-10]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths..[?((@ != null && @.type === 'array'))]
    then:
      field: minItems
      function: is-not-undefined

  # MUSS Standard-Status-Codes verwenden [08-01]
  08-01_SHOULD-use-well-understood-http-status-codes:
    message: '{{error}}'
    description: MUSS Standard-Status-Codes verwenden [08-01]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths.*
    then:
      function: assert-http-codes-for-operation
      functionOptions:
        wellUnderstood:
          # Success Codes
          '200': [ ALL ]
          '201': [ POST, PUT ]
          '202': [ POST, PUT, DELETE, PATCH ]
          '204': [ PUT, DELETE, PATCH ]
          '207': [ POST, PUT ]

          # Redirection Codes
          #'301': [ALL]
          #'303': [PATCH, POST, PUT, DELETE]
          #'304': [GET, HEAD]

          # Client Side Error Codes
          '400': [ ALL ]
          '401': [ ALL ]
          '403': [ ALL ]
          '404': [ GET, PATCH, POST, PUT ]
          #'405': [ALL]
          #'406': [ALL]
          #'408': [ALL]
          '409': [ POST, PUT, DELETE, PATCH ]
          #'410': [ALL]
          #'412': [PUT, DELETE, PATCH]
          '415': [ POST, PUT, DELETE, PATCH ]
          #'423': [PUT, DELETE, PATCH]
          #'428': [ALL]
          #'429': [ALL]

          # Server Side Error Codes
          '500': [ ALL ]
          #'501': [ALL]
          #'503': [ALL]

          # OpenApi
          'default': [ ALL ]

  # MUST specify success and error responses [08-02]
  08-02_MUST-specify-default-response:
    message: Operation does not contain a default response
    description: MUSS Erfolg und Fehler spezifizieren [08-02]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*.responses
    then:
      field: default
      function: truthy

  # MUST use standard HTTP status codes [08-03]
  08-03_MUST-use-standard-http-status-codes:
    message: '{{property}} is not a standardized response code'
    description: MUSS Standard-Status-Codes verwenden [08-03]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*.responses.*~
    then:
      function: enumeration
      functionOptions:
        values:
          - '100'
          - '101'
          - '200'
          - '201'
          - '202'
          - '203'
          - '204'
          - '205'
          - '206'
          - '207'
          - '300'
          - '301'
          - '302'
          - '303'
          - '304'
          - '305'
          - '307'
          - '400'
          - '401'
          - '402'
          - '403'
          - '404'
          - '405'
          - '406'
          - '407'
          - '408'
          - '409'
          - '410'
          - '411'
          - '412'
          - '413'
          - '414'
          - '415'
          - '416'
          - '417'
          - '423'
          - '426'
          - '428'
          - '429'
          - '431'
          - '500'
          - '501'
          - '502'
          - '503'
          - '504'
          - '505'
          - '511'
          - default

  # MUST muse Error Json[08-05]
  08-05_MUST-use-valid-error-json-schema:
    message: '{{error}}'
    description: MUSS Error-Object verwenden [08-05]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.components.schemas
    then:
      field: Error
      function: is-error-json-schema

  # SHOULD prefer hyphenated-pascal-case for HTTP header fields [09-02]
  09-02_SHOULD-use-hyphenated-pascal-case-for-header-parameters:
    message: Header parameters SHOULD be Kebab-Case
    description: MUSS einheitliches Format für Header-Parameter verwenden [09-02]
    documentationUrl:  https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths..parameters[?(@ && @.in=='header')].name
    then:
      function: rule-132

  # MUSS verpflichtende Headers implementieren (09-04)
  09-04_MUST-use-header-api-key:
    message: "MUST specify 'x-api-key' as required header"
    description: MUSS verpflichtende Headers implementieren [09-04]
    severity: error
    given: "$.paths[*][*].parameters"
    then:
      function: truthy
      field: "$.[?(@.in == 'header' && @.name == 'x-api-key' && @.required == true)]"

  # MUSS verpflichtende Headers implementieren (09-04)
  # MUSS custom-header-Versionierung verwenden (13-06)
  09-04_MUST-use-header-api-version:
    message: "MUST specify 'x-api-version' as required header"
    description: MUSS verpflichtende Headers implementieren (09-04) + MUSS custom-header-Versionierung verwenden [13-06]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: "$.paths[*][*].parameters"
    then:
      function: truthy
      field: "$.[?(@.in == 'header' && @.name == 'x-api-version' && @.required == true)]"

  # MUSS Routing Headers implementieren (09-05)
  09-05_MUST-use-header-as-tenant-or-as-product:
    message: "{{error}}"
    description: "Exactly one of both headers is required to enable routing to the correct target cluster"
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: "$.paths[*][*].parameters"
    then:
      function: has-exactly-one-of-required-headers
      functionOptions:
        exclusiveHeaders:
          - x-as-tenant
          - x-as-product

  # MUSS Routing Headers implementieren (09-05)
  09-05_MUST-use-header-as-audience:
    message: "{{error}}"
    description: "The audience header is required for internal calls to implement and enforce WAF rules.
    The header value SHOULD be specified as an x-entensible-enum with at least one value that matches the
    respective API audience. Specifying more than one enum value usually makes no sense since one API file has
    exactly one audience (see [01-05])."
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: "$.paths[*][*].parameters"
    then:
      function: has-audience-header
      functionOptions:
        headerName: "x-as-audience"
        audienceToHeaderValueMap:
          "federation-internal" : "FEDERATION_INTERNAL"
          "insurance-internal" : "INSURANCE_INTERNAL"
          "cluster-internal" : "CLUSTER_INTERNAL"
          "service-internal" : "SERVICE_INTERNAL"

  # MUST not use URI versioning [13-07]
  13-07_MUST-NOT-use-uri-versioning:
    message: Path MUST not contain versioning
    description: MUSS keine URL Versionierung verwenden [13-07]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*~
    then:
      function: pattern
      functionOptions:
        notMatch: /v[0-9]+/

  # MUST always return JSON objects as top-level data structures [13-08]
  13-08_MUST-always-return-json-objects-as-top-level-data-structures:
    message: 'Top-level data structure MUST be an object'
    description: MUSS immer ein JSON-Objekt als Top-Level-Element verwenden. [13-08]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: error
    given: $.paths.*.*[responses,requestBody]..content..schema
    then:
      function: is-object-schema

  # SHOULD use open-ended list of values (x-extensible-enum) for enumerations [13-09]
  13-09_SHOULD-use-x-extensible-enum:
    message: 'Should use `x-extensible-enum` instead of `enum`'
    description: SOLL extendable-enum für Enums verwenden [13-09]
    documentationUrl: https://confluence.aok-systems.de/display/public/SORLPR/Arbeitsanweisung+API
    severity: warn
    given: $.paths..[?(@ != null && @.schema != null)]
    then:
      function: enum-allow-list

  # TODO: [DK] check default
  # MUST-use-problem-json-as-default-response:
  #  message: Operation MUST use problem json as default response
  #  description: MUST specify success and error responses [151]
  #  documentationUrl: https://opensource.zalando.com/restful-api-guidelines/#151
  #  severity: error
  #  given: $.paths.*.*.responses.default
  #  then:
  #    field: content.application/problem+json
  #    function: truthy

  # TODO: [DK] check default
  # MUST support problem JSON [176]
  # => https://opensource.zalando.com/restful-api-guidelines/#176

  #MUST-use-problem-json-for-errors:
  #  message: Error response MUST be application/problem+json
  #  description: MUST support problem JSON [176]
  #  documentationUrl: https://opensource.zalando.com/restful-api-guidelines/#176
  #  severity: error
  #  given: $.paths.*.*.responses[?(@ && @property.match(/^(4|5)/))]
  #  then:
  #    field: content.application/problem+json
  #    function: truthy
